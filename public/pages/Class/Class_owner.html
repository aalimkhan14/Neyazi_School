<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        #rparent{
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: start;
            width: 100%;
            height: fit-content;
        }
        form{
            width: 49.5% !important;
        }
        #table_layout{
            height: 600px !important;
        }
        label{
            width: 49%;    
        }
        
        .th:nth-child(1), .th:nth-child(5){
            width: 5%;
        }
        tr td:nth-child(5){
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
        }
        /* Action */
        #cover{
            display: flex;
            justify-content: center;
            align-items: center;
            width: 80%;
            height: 50px;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <div id="rparent">
    <form id="class_owner" class="rcover">
        <input type="hidden" id="id" name="id">
        <div id="rheader">معرفی نگران به صنف</div>
        <div id="rcontent">
            <div id="one">
                <label for="teacherselection">انتخاب استاد:
                    <select name="teacherselection" id="teacherselection" required>
                        <option value="">استاد را انتخاب کنید</option>
                    </select>
                </label>
                <label for="classselection">انتخاب صنف:<select name="classselection" id="classselection" required>
                    <option value="">صنف راانتخاب کنید</option>
                </select></label>
            </div>
        </div>
        <div id="rfooter">
            <input type="submit" id="save" value="ثبت کردن" />
            <input type="button" value="ثبت کردن" id="save1" style="display: none;">
            <input type="reset" id="exit" value="پاک کردن" />
        </div>
    </form>
    <div class="rcover" style="width: 49.5%;">
        <div id="rheader">نگران ها</div>
        <div id="rcontent" id="table_layout">
            <table>
                <thead>
                    <th class="th">نمبر</th>
                    <th class="th">استاد</th>
                    <th class="th">صنف</th>
                    <th class="th">تاریخ</th>
                    <th class="th">عملکرد</th>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        <div id="rfooter">
                <div id="pagination" style="text-align: center; margin-top: 20px">
                    <div id="pagination-buttons"></div>
                </div>
        </div>
    </div>
    </div>

    <script src="../../js/Date_Elemet.js"></script>
    <script>
        // Loading list of classes
        async function loadClass(){
            let classList = document.getElementById('classselection');
            const res = await fetch('http://localhost:3000/classes')
            const data = await res.json();
            data.data.forEach((classe) => {
                const optionValue = `${classe.classlevel} ${classe.classmodify}`;
                classList.innerHTML += `<option value="${optionValue}">${optionValue}</option>`;
            });
        }
        // Loading list of Teachers
        loadClass();

        async function loadTeacher() {
            let teacherList = document.getElementById('teacherselection');
            const res = await fetch('http://localhost:3000/teachers');
            const data =await res.json();

            data.data.forEach((teacher)=>{
                const optionValue = `${teacher.name} ${teacher.lname}`;
                teacherList.innerHTML += `<option value="${optionValue}">${optionValue}</option>`;  
            })
        }
        loadTeacher();


        document.getElementById("class_owner").addEventListener("submit", async function (e) {
            e.preventDefault();
            const form = e.target; 
            // Build a JSON object from form fields
            const data = {
                teacher: form.teacherselection.value,
                classe: form.classselection.value,
            }; 
            try {
              const response = await fetch("http://localhost:3000/classowner", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
            });
            if (response.ok) {
                showModal({
                  	title: "موفقیت",
                  	message: "نگران صنف موفقانه ثبت شد.",
                  	icon: "success",
                });
                form.reset();
                showClassOwnerData();
            } else {
                alert("خطا در ثبت نگران صنف.");
                console.log(response);
            }
            } catch (error) {
              console.error("Error: ", error);
              alert("خطا در اتصال به سرور");
            }
        });


      
        // get Data

    function showClassOwnerData() {
      const rowsPerPage = 10;
      let currentPage = 1;
      let totalPages = 1;

      const searchInput = document.getElementById("searchtable");
      const filterBySelect = document.getElementById("sffilter");
      const tbody = document.getElementById("tbody");
      const paginationButtons = document.getElementById("pagination-buttons");

      async function fetchAndRender() {
      const response = await fetch(`http://localhost:3000/classowner?page=${currentPage}&limit=${rowsPerPage}`);

      const result = await response.json();

      if (!Array.isArray(result.data)) {
        console.error("❌ result.data is not an array:", result);
        return;
      }

      tbody.innerHTML = "";
      result.data.forEach((classowner, index) => {
        tbody.innerHTML += `
          <tr data-class-id='${classowner.id}'  ondblclick="editPart(this.dataset.classId)">
            <td>${(currentPage - 1) * rowsPerPage + index + 1}</td>
            <td>${classowner.teacher}</td>
            <td>${classowner.classe}</td>
            <td>${classowner.createdAt ? toPersianDate(classowner.createdAt) : ""}</td>
            <td>
              <div id="cover">
                <div id="action">
                  <div id="action3" class='action3' onclick='deleteClassOwner(${classowner.id})' title="del"></div>
                </div>
              </div>
            </td>
          </tr>`;
        });


        // ✅ Set the SVG icons
        setTimeout(() => {
          document.querySelectorAll(".action3").forEach((el) => (el.innerHTML = del));
        }, 0);

        totalPages = Math.ceil(result.total / rowsPerPage);
        renderPagination();
      }


      function renderPagination() {
        paginationButtons.innerHTML = "";

        function addButton(label, page, disabled = false, active = false) {
          const btn = document.createElement("button");
          btn.textContent = label;
          btn.disabled = disabled;
          if (active) btn.style.backgroundColor = "#357edd";
          btn.addEventListener("click", () => {
            currentPage = page;
            fetchAndRender();
          });
          paginationButtons.appendChild(btn);
        }

        addButton("<<", 1, currentPage === 1);
        addButton("<", currentPage - 1, currentPage === 1);

        for (let i = 1; i <= totalPages; i++) {
          if (
            i === currentPage ||
            i <= 4 ||
            i === totalPages ||
            Math.abs(currentPage - i) <= 1
          ) {
            addButton(i, i, false, i === currentPage);
          }
        }

        addButton(">", currentPage + 1, currentPage === totalPages);
        addButton(">>", totalPages, currentPage === totalPages);
      }
      const del = `<svg xmlns="http://www.w3.org/2000/svg" width='18px' viewBox="0 0 26 26"><path d="M12.1875 -0.03125C10.472656 -0.03125 9.097656 1.3125 9 3L5 3C4.398438 3 4 3.398438 4 4L3.59375 4C2.695313 4 2 4.695313 2 5.59375L2 6L24 6L24 5.59375C24 4.695313 23.304688 4 22.40625 4L22 4C22 3.398438 21.601563 3 21 3L17 3C16.902344 1.3125 15.527344 -0.03125 13.8125 -0.03125 Z M 12.1875 2.03125L13.8125 2.03125C14.367188 2.03125 14.839844 2.464844 14.9375 3L11.0625 3C11.160156 2.464844 11.632813 2.03125 12.1875 2.03125 Z M 3.09375 7L6 26L20 26L22.90625 7 Z M 5.90625 10L7 10L8.6875 23L7.6875 23 Z M 10.1875 10L11.3125 10L12 23L10.8125 23 Z M 14.6875 10L15.8125 10L15.1875 23L14.09375 23 Z M 19 10L20 10L18.3125 23L17.3125 23Z" fill="#FFFFFF" /></svg>`;
      // First Load
      fetchAndRender();
    }
    showClassOwnerData();

    // Fee Delete function
    function deleteClassOwner(id) {

      async function apply(){
            const confirmed = await showModal({
            title: "حذف",
            message: "آیا می‌خواهید فیس حذف شود؟",
            type: "ok-cancel"
          });
        
          if (confirmed) {
            console.log("User confirmed ✅");
            fetch(`http://localhost:3000/classowner/${id}`, {
          method: "DELETE",
        })
          .then(async (response) => {
            if (!response.ok) {
              throw new Error("خطا در حذف نگران صنف");
            }

            const data = await response.json(); // ✅ Works because backend sends JSON now
            showClassOwnerData(); // ✅ Reload table
          })
          .catch((error) => {
            console.error("❌ خطا در اتصال یا سرور:", error);
            alert("خطا در اتصال یا سرور");
          });

          } else {
            this.close();
            console.log("User cancelled ❌");
          }
        }
        apply();
      
    }

    function editPart(classId){
      document.getElementById('save').style.display = 'none';
      document.getElementById('save1').style.display = 'flex';
      fetch(`http://localhost:3000/classowner/${classId}`).then(res => res.json()).then(classowner => {
        if(!classowner) return;
        console.log(classowner.id)
        document.getElementById('id').value = classowner.id;
        document.getElementById('teacherselection').value = classowner.teacher;
        document.getElementById('classselection').value = classowner.classe;
      })
    }
    document.getElementById('save1').addEventListener('click', function () {
      const form = document.getElementById('class_owner');

      // Collect form data as JSON object
      const data = {
        teacher: form.teacherselection.value,
        classe: form.classselection.value,
      };

      const id = document.getElementById('id').value.trim();

      fetch(`/classowner/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      }).then(res => {
        if (!res.ok) throw new Error("Server error");
        return res.json();
      }).then(data => {
        showModal({
          	title: "موفقیت",
          	message: "تغییرات موفقانه ثبت شد.",
          	icon: "success",
        });
        showClassOwnerData();
      }).catch(err => {
        console.error("خطا در تغییر داده:", err);
        alert("خطا در ذخیره تغییرات ❌");
      });
    });
    document.getElementById('exit').addEventListener('click', ()=>{
      document.getElementById('save1').style.display= 'none';
      document.getElementById('save').style.display= 'flex';
    })

    </script>
</body>
</html>