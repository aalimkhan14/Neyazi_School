<!DOCTYPE html>
<html lang="ps" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            #rparent{
                flex-direction: row;
                justify-content: space-between;
                align-items: start;
            }
            .rcover:nth-child(1){
                width: 30%;
            }
            #one{
                flex-direction: column;
                width: 100%;
                height: fit-content;
            }
            #one *{
                width: 100%;
            }
            .rcover:nth-child(2){
                width:69%;
            }

            .th:nth-child(1), .th:nth-child(5){
                width: 5%;
            }
            tr td:nth-child(5){
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 5px;
            }
        </style>
    </head>
    <body>
        
        <div id="rparent">
            <form id="class_registration" class="rcover">
                <div id="rheader">ایجاد صنف جدید</div>
                <div id="rcontent">
                    <input type="hidden" id="id" name="id">
                    <div id="one">
                        <label for="classlevel">سطح صنف:
                          <select name="classlevel" id="classlevel" required>
                            <option value="" selected>سطح صنف را انتخاب کنید</option>
                            <option value="نرسری">نرسری</option>
                            <option value="آماده گی">آماده گی</option>
                            <option value="اول">اول</option>
                            <option value="دوم">دوم</option>
                            <option value="سوم">سوم</option>
                            <option value="چهارم">چهارم</option>
                            <option value="پنجم">پنجم</option>
                            <option value="ششم">ششم</option>
                            <option value="هفتم">هفتم</option>
                            <option value="هشتم">هشتم</option>
                            <option value="نهم">نهم</option>
                            <option value="دهم">دهم</option>
                            <option value="یازدهم">یازدهم</option>
                            <option value="دوازدهم">دوازدهم</option>
                          </select>
                        </label>
                        <label for="classmodify">شاخص صنف:
                            <select name="classmodify" id="classmodify" required>
                                <option value="" disabled selected>شاخص صنف را انتخاب کنید</option>
                                <option value="الف">الف</option>
                                <option value="ب">ب</option>
                                <option value="ت">ت</option>
                                <option value="ث">ث</option>
                                <option value="ج">ج</option>
                                <option value="ح">ح</option>
                                <option value="خ">خ</option>
                                <option value="د">د</option>
                                <option value="ذ">ذ</option>
                                <option value="ر">ر</option>
                                <option value="ز">ز</option>
                                <option value="س">س</option>
                                <option value="ش">ش</option>
                                <option value="ص">ص</option>
                                <option value="ض">ض</option>
                            </select>
                        </label>
                        <label for="classtime">تایم درسی:<input id="classtime" name="classtime" required type="text"></label>                               
                        <label for=""><input type="hidden" id="order_no" name="order_no"></label>
                      </div>
                </div>
                <div id="rfooter">
          <input type="submit" id="save" value="ثبت کردن" />
          <input type="button" value="ثبت کردن" id="save1" style="display: none;">
          <input type="reset" id="exit" value="پاک کردن" />
        </div>
            </form>

            
        <div  class="rcover">
            <div id="rheader">صنف های ثبت شده</div>
            <div id="rcontent" style="height: 600px;">
                <table>
                    <thead>
                        <th class="th">نمبر</th>
                        <th class="th">صنف</th>
                        <th class="th">نایم درسی</th>
                        <th class="th">تاریخ ایجاد</th>
                        <th class="th">عملکرد</th>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
            <div id="rfooter">
                <div id="pagination" style="text-align: center; margin-top: 20px">
                    <div id="pagination-buttons"></div>
              </div>
            </div>
        </div>
    </div>
    <script src="../../js/Date_Elemet.js"></script>
    <script>
      document.getElementById('classlevel').addEventListener('change',()=>{
        const classlevel = document.getElementById('classlevel').value;
        const order_no = document.getElementById('order_no');

        if(classlevel === 'نرسری'){
          order_no.value = '1';
        }else if(classlevel === 'آماده گی'){
          order_no.value = '2';
        }else if(classlevel === 'اول'){
          order_no.value = '3';
        }else if(classlevel === 'دوم'){
          order_no.value = '4';
        }else if(classlevel === 'سوم'){
          order_no.value = '5';
        }else if(classlevel === 'چهارم'){
          order_no.value = '6';
        }else if(classlevel === 'پنجم'){
          order_no.value = '7';
        }else if(classlevel === 'ششم'){
          order_no.value = '8';
        }else if(classlevel === 'هفتم'){
          order_no.value = '9';
        }else if(classlevel === 'هشتم'){
          order_no.value = '10';
        }else if(classlevel === 'نهم'){
          order_no.value = '11';
        }else if(classlevel === 'دهم'){
          order_no.value = '12';
        }else if(classlevel === 'یازدهم'){
          order_no.value = '13';
        }else{
          order_no.value = '14';
        }
      })
        

        document.getElementById("class_registration").addEventListener("submit", async function (e) {
        e.preventDefault();
        const form = e.target; 
        // Build a JSON object from form fields
        const data = {
            classlevel: form.classlevel.value,
            classmodify: form.classmodify.value,
            classtime: form.classtime.value.trim(),
            order_no: form.order_no.value,
        }; 
        try {
          const response = await fetch("http://localhost:3000/classes", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });
          if (response.ok) {
            showModal({
              	title: "موفقیت",
              	message: "صنف موفقانه ثبت شد.",
              	icon: "success",
            });
            form.reset();
            showClassData();
          } else {
            alert("خطا در ثبت صنف.");
            console.log(response);
          }
        } catch (error) {
          console.error("Error: ", error);
          alert("خطا در اتصال به سرور");
        }
      });


      
    // get Data

    function showClassData() {
      const rowsPerPage = 10;
      let currentPage = 1;
      let totalPages = 1;

      const searchInput = document.getElementById("searchtable");
      const filterBySelect = document.getElementById("sffilter");
      const tbody = document.getElementById("tbody");
      const paginationButtons = document.getElementById("pagination-buttons");

      async function fetchAndRender() {
      const response = await fetch(`http://localhost:3000/classes?page=${currentPage}&limit=${rowsPerPage}`);

      const result = await response.json();

      if (!Array.isArray(result.data)) {
        console.error("❌ result.data is not an array:", result);
        return;
      }

      tbody.innerHTML = "";
      result.data.forEach((classreg, index) => {
        tbody.innerHTML += `
          <tr data-class-id='${classreg.id}'  ondblclick="editPart(this.dataset.classId)">
            <td>${(currentPage - 1) * rowsPerPage + index + 1}</td>
            <td>${classreg.classlevel} ${classreg.classmodify}</td>
            <td>${classreg.classtime}</td>
            <td>${classreg.createdAt ? toPersianDate(classreg.createdAt) : ""}</td>
            <td>
              <div id="cover">
                <div id="action">
                  <div id="action3" class='action3' onclick='deleteClass(${classreg.id})' title="del"></div>
                </div>
              </div>
            </td>
          </tr>`;
        });


        // ✅ Set the SVG icons
        setTimeout(() => {
          document.querySelectorAll(".action2").forEach((el) => (el.innerHTML = edit));
          document.querySelectorAll(".action3").forEach((el) => (el.innerHTML = del));
        }, 0);

        totalPages = Math.ceil(result.total / rowsPerPage);
        renderPagination();
      }


      function renderPagination() {
        paginationButtons.innerHTML = "";

        function addButton(label, page, disabled = false, active = false) {
          const btn = document.createElement("button");
          btn.textContent = label;
          btn.disabled = disabled;
          if (active) btn.style.backgroundColor = "#357edd";
          btn.addEventListener("click", () => {
            currentPage = page;
            fetchAndRender();
          });
          paginationButtons.appendChild(btn);
        }

        addButton("<<", 1, currentPage === 1);
        addButton("<", currentPage - 1, currentPage === 1);

        for (let i = 1; i <= totalPages; i++) {
          if (
            i === currentPage ||
            i <= 4 ||
            i === totalPages ||
            Math.abs(currentPage - i) <= 1
          ) {
            addButton(i, i, false, i === currentPage);
          }
        }

        addButton(">", currentPage + 1, currentPage === totalPages);
        addButton(">>", totalPages, currentPage === totalPages);
      }
      const del = `<svg xmlns="http://www.w3.org/2000/svg" width='18px' viewBox="0 0 26 26"><path d="M12.1875 -0.03125C10.472656 -0.03125 9.097656 1.3125 9 3L5 3C4.398438 3 4 3.398438 4 4L3.59375 4C2.695313 4 2 4.695313 2 5.59375L2 6L24 6L24 5.59375C24 4.695313 23.304688 4 22.40625 4L22 4C22 3.398438 21.601563 3 21 3L17 3C16.902344 1.3125 15.527344 -0.03125 13.8125 -0.03125 Z M 12.1875 2.03125L13.8125 2.03125C14.367188 2.03125 14.839844 2.464844 14.9375 3L11.0625 3C11.160156 2.464844 11.632813 2.03125 12.1875 2.03125 Z M 3.09375 7L6 26L20 26L22.90625 7 Z M 5.90625 10L7 10L8.6875 23L7.6875 23 Z M 10.1875 10L11.3125 10L12 23L10.8125 23 Z M 14.6875 10L15.8125 10L15.1875 23L14.09375 23 Z M 19 10L20 10L18.3125 23L17.3125 23Z" fill="#FFFFFF" /></svg>`;
      // First Load
      fetchAndRender();
    }
    showClassData();

    // Fee Delete function
    function deleteClass(id) {

      async function apply(){
          const confirmed = await showModal({
          title: "حذف",
          message: "آیا می‌خواهید فیس حذف شود؟",
          type: "ok-cancel"
        });
        
        if (confirmed) {
          console.log("User confirmed ✅");
          fetch(`http://localhost:3000/classes/${id}`, {
          method: "DELETE",
        })
          .then(async (response) => {
            if (!response.ok) {
              throw new Error("خطا در حذف صنف");
            }
            const data = await response.json(); // ✅ Works because backend sends JSON now
            showClassData(); // ✅ Reload table
          })
          .catch((error) => {
            console.error("❌ خطا در اتصال یا سرور:", error);
            alert("خطا در اتصال یا سرور");
          });
            } else {
              this.close();
              console.log("User cancelled ❌");
            }
        }
        apply();
    }

    function editPart(classId){
      document.getElementById('save').style.display = 'none';
      document.getElementById('save1').style.display = 'flex';
      fetch(`http://localhost:3000/classes/${classId}`).then(res => res.json()).then(classe => {
        if(!classe) return;
        console.log(classe.id)
        document.getElementById('id').value = classe.id;
        document.getElementById('classlevel').value = classe.classlevel;
        document.getElementById('classmodify').value = classe.classmodify;
        document.getElementById('classtime').value = classe.classtime;
        document.getElementById('order_no').value = classe.order_no;
      })
    }
    document.getElementById('save1').addEventListener('click', function () {
      const form = document.getElementById('class_registration');

      // Collect form data as JSON object
      const data = {
        classlevel: form.classlevel.value,
        classmodify: form.classmodify.value,
        classtime: form.classtime.value,
        order_no: form.order_no.value,
      };

      const id = document.getElementById('id').value.trim();

      fetch(`/classes/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      }).then(res => {
        if (!res.ok) throw new Error("Server error");
        return res.json();
      }).then(data => {
        showModal({
              	title: "موفقیت",
              	message: "تغییرات موفقانه ثبت شد.",
              	icon: "success",
            });
        showClassData();
      }).catch(err => {
        console.error("خطا در تغییر داده:", err);
        alert("خطا در ذخیره تغییرات ❌");
      });
    });



    document.getElementById('exit').addEventListener('click', ()=>{
      document.getElementById('save1').style.display= 'none';
      document.getElementById('save').style.display= 'flex';
    })

    </script>
</body>
</html>