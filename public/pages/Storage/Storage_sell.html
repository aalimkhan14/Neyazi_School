<!DOCTYPE html>
<html lang="ps" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    #sell_registration{ min-height: 700px; }
    #sell_content{ display: flex; flex-direction: row; width: 100%; height: 75%; background-color: #fff; }
    .info{ display: flex; flex-direction: column; width: 35%; padding: 20px; box-sizing: border-box; border-left: 2px solid #ccc; }
    .info label{ margin-bottom: 15px; width: 100%; }
    .productlist{ display: flex; flex-direction: column; width: 65%; padding: 20px; box-sizing: border-box; }
    label{ width: 32.5%; }
    .th:nth-child(1), .th:nth-child(9){ width: 5%; }
    tr td:nth-child(9){ display: flex; justify-content: center; align-items: center; padding: 5px; }
    fieldset{ display: flex; width: 250px; height: 60px; border: none; position: relative; left: -20px; top: 16px; }
    fieldset div{ display: flex; flex-direction: column; justify-content: center !important; width: 100%; height: 50%; }
    fieldset label{ display: flex !important; flex-direction: row; justify-content: start; align-items: center; width: 50%; height: 100%; }
    fieldset input{ width: 18px !important; margin-left: 10px !important; }
    #addProductBtn, .removeProductBtn{ margin-top: 10px; cursor: pointer; }
    #totalAmount{ margin-top: 15px; font-weight: bold; }
    .action3{
      background-color: red;
      border-radius: 4px;
      padding: 5px;
      border: none;
    }
    .qtyInput{
      border: none;
      height: fit-content;
    }
</style>
</head>
<body>
<div id="rparent">
<form id="sell_registration" class="rcover">
    <div id="rheader">فروش جنس</div>
    <div id="sell_content">
        <div class="info">
            <label for="customer">اسم مشتری:<input id="customer" name="customer" type="text" required></label>
            <label for="productScan">بار کود محصول:<input id="productScan" type="text" required></label>
        </div>
        <div class="productlist">
            <table id="productTable">
                <thead>
                <tr>
                    <th>شماره</th>
                    <th>محصول</th>
                    <th>تعداد</th>
                    <th>قیمت</th>
                    <th>عملکرد</th>
                </tr>
                </thead>
                <tbody id="productTbody"></tbody>
            </table>
            <div id="totalAmount">مجموع قیمت: 0</div>
        </div>
    </div>
    
    <div id="rfooter">
        <input type="submit" id="save" value="ثبت کردن" />
        <input type="reset" id="exit" value="پاک کردن" />
    </div>
</form>

<!-- Sold products table -->
<div class="rcover">
    <div id="rheader">اجناس فروخته شده</div>
    <div id="rcontent">
        <div id="searchbar" class="search_bar">
            <div id="right" class="sright">
                <input type="text" class="search_table" id="searchtable" placeholder="جستجو . . ."/>
                <fieldset>
                    <div>
                        <label for="goods"><input type="radio" name="filter" id="goods" value="goods">جنس</label>
                        <label for="customer"><input type="radio" name="filter" id="customer" value="customer" checked>مشتری</label>
                    </div>
                </fieldset>
                <select id="sffilter" class="s_f_filter">
                    <option value="" selected>همه کتگوری</option>
                </select>
            </div>
            <div id="left" class="sleft"></div>
        </div>
        <table>
            <thead>
                <th class="th">نمبر</th>
                <th class="th">اسم مشتری</th>
                <th class="th">کتگوری/th>
                <th class="th">جنس</th>
                <th class="th">قیمت</th>
                <th class="th">تعداد</th>
                <th class="th">قیمت مجموع</th>
                <th class="th">تاریخ فروش</th>
                <th class="th">عملکرد</th>
            </thead>
            <tbody id="sell_tbody"></tbody>
        </table>
        <div id="rfooter">
            <div id="pagination" style="text-align: center; margin-top: 20px">
                <div id="pagination-buttons"></div>
            </div>
        </div>
    </div>
</div>

<script src="./../../js/Date_Elemet.js"></script>
<script>

  (() => {
    // All your existing JS code goes here
    
let storageData = [];
let cart = [];

// Load storage and categories
async function loadStorage() {
    const res = await fetch('http://localhost:3000/storage');
    const data = await res.json();
    storageData = data.data;

    const catSelect = document.getElementById('sffilter');
    catSelect.innerHTML = '<option value="">همه کتگوری</option>';
    const uniqueCats = [...new Set(storageData.map(item => item.catagory))];
    uniqueCats.forEach(cat => catSelect.innerHTML += `<option value="${cat}">${cat}</option>`);
}
loadStorage();

// Add product automatically when barcode scanned (Enter key)
const barcodeInput = document.getElementById("productScan");
barcodeInput.addEventListener("keypress", async function(e) {
    if (e.key !== "Enter") return;
    e.preventDefault();
    const barcode = e.target.value.trim();
    if(!barcode) return alert("لطفا بارکد محصول را وارد کنید");

    try {
        const res = await fetch(`http://localhost:3000/storage/barcode/${barcode}`);
        if(!res.ok) return alert("محصول یافت نشد");
        const product = await res.json();

        const existing = cart.find(p => p.barcode === product.barcode);
        if(existing) existing.quantity += 1;
        else cart.push({...product, quantity: 1});

        renderCart();
        e.target.value = "";
        e.target.focus();
    } catch(err) {
        console.error(err);
        alert("خطا در دریافت محصول");
    }
});

// Render cart table
function renderCart() {
    const tbody = document.querySelector(".productlist tbody");
    if(!tbody) return;
    tbody.innerHTML = "";
    let total = 0;

    cart.forEach((item, index) => {
        const itemTotal = item.sellamount * item.quantity;
        total += itemTotal;
        document.getElementById("totalAmount").innerText = `مجموع قیمت: ${total}`;
        

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${index+1}</td>
            <td>${item.name}</td>
            <td><input type="number" class="qtyInput" min="1" value="${item.quantity}" data-index="${index}" class="qtyInput"></td>
            <td>${item.sellamount}</td>
            <td><button type="button" class="removeProductBtn action3" data-index="${index}"></button></td>
        `;
        setTimeout(() => {
          document.querySelectorAll(".action3").forEach((el) => (el.innerHTML = del));
        }, 0);
        tbody.appendChild(row);
    });

    // Quantity change
    document.querySelectorAll(".qtyInput").forEach(input => {
        input.addEventListener("input", e => {
            const idx = e.target.dataset.index;
            cart[idx].quantity = parseInt(e.target.value) || 1;
            renderCart();
        });
    });

    // Remove product
    document.querySelectorAll(".removeProductBtn").forEach(btn => {
        btn.addEventListener("click", e => {
            const idx = e.target.dataset.index;
            cart.splice(idx, 1);
            renderCart();
        });
    });
}

// Submit sell form only via Submit button click
document.getElementById("save").addEventListener("click", async function(e){
    e.preventDefault();
    if(cart.length === 0) return alert("هیچ محصولی انتخاب نشده");

    const customer = document.getElementById("customer").value.trim();

    for(const item of cart) {
        const data = {
            customer,
            catagory: item.catagory,
            goods: item.name,
            price: item.sellamount,
            quantity: item.quantity
        };
        await fetch("http://localhost:3000/sell", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(data)
        });
    }

    alert("فروش با موفقیت ثبت شد");
    cart = [];
    renderCart();
    document.getElementById("sell_registration").reset();
    barcodeInput.focus();
     
    showSellData();
});
const del = `<svg xmlns="http://www.w3.org/2000/svg" width='18px' viewBox="0 0 26 26"><path d="M12.1875 -0.03125C10.472656 -0.03125 9.097656 1.3125 9 3L5 3C4.398438 3 4 3.398438 4 4L3.59375 4C2.695313 4 2 4.695313 2 5.59375L2 6L24 6L24 5.59375C24 4.695313 23.304688 4 22.40625 4L22 4C22 3.398438 21.601563 3 21 3L17 3C16.902344 1.3125 15.527344 -0.03125 13.8125 -0.03125 Z M 12.1875 2.03125L13.8125 2.03125C14.367188 2.03125 14.839844 2.464844 14.9375 3L11.0625 3C11.160156 2.464844 11.632813 2.03125 12.1875 2.03125 Z M 3.09375 7L6 26L20 26L22.90625 7 Z M 5.90625 10L7 10L8.6875 23L7.6875 23 Z M 10.1875 10L11.3125 10L12 23L10.8125 23 Z M 14.6875 10L15.8125 10L15.1875 23L14.09375 23 Z M 19 10L20 10L18.3125 23L17.3125 23Z" fill="#FFFFFF" /></svg>`;
     

// Prevent form submission by Enter in any input
document.getElementById("sell_registration").addEventListener("keypress", function(e){
    if(e.key === "Enter") e.preventDefault();
});

// Show sold products
async function showSellData() {
    const tbody = document.getElementById("sell_tbody");
    tbody.innerHTML = "";

    const search = document.getElementById("searchtable").value;
    const category = document.getElementById("sffilter").value;
    const filterField = document.querySelector("input[name='filter']:checked").value;

    const res = await fetch(`http://localhost:3000/sell?search=${encodeURIComponent(search)}&filterBy=${encodeURIComponent(filterField)}&category=${encodeURIComponent(category)}`);
    const result = await res.json();

    if(!Array.isArray(result.data)) return;

    result.data.forEach((sell, index) => {
        const totalPrice = sell.price * sell.quantity;
        tbody.innerHTML += `
            <tr>
                <td>${index+1}</td>
                <td>${sell.customer}</td>
                <td>${sell.catagory}</td>
                <td>${sell.goods}</td>
                <td>${sell.price}</td>
                <td>${sell.quantity}</td>
                <td>${totalPrice}</td>
                <td>${sell.createdAt ? toPersianDate(sell.createdAt) : ""}</td>
                <td><button  class="action3"  onclick="deleteSell(${sell.id})"></button></td>
            </tr>
        `;

    });
    setTimeout(() => {
          document.querySelectorAll(".action3").forEach((el) => (el.innerHTML = del));
        }, 0);
}

// Delete sold product
function deleteSell(id){
    if(!confirm("آیا می‌خواهید حذف شود؟")) return;
    fetch(`http://localhost:3000/sell/${id}`, {method: "DELETE"})
        .then(()=> showSellData());
}

// Reload data on search/filter change
document.getElementById("searchtable").addEventListener("input", showSellData);
document.getElementById("sffilter").addEventListener("change", showSellData);
document.querySelectorAll("input[name='filter']").forEach(radio => radio.addEventListener("change", showSellData));

showSellData();
  })();
</script>

</body>
</html>
